---
title: "Spotify_API_Pull"
author: "Alfredo Lorenzo Mendiola"
date: "`r Sys.Date()`"
output: pdf_document
---

This is a file to pull data from the Spotify API and save it in dataframes for use in a separate file.
The following URL provides information on the spotifyr package and its use:
https://www.rdocumentation.org/packages/spotifyr/versions/2.2.4
*Valid as of 13Nov2023*

```{r}
# Libraries
library(spotifyr)
library(tidyverse)
library(knitr)
library(dplyr)
library(ggplot2)
library(purrr)
library(psych)
library(readr)
library(data.table)
```

Spotify made playlists are saved in a folder in Alfredo L Mendiola's Spotify account for referencing to. The following playlist_id values are pulled from a section of the sharable link of the playlists.
```{r}
# global vars
playlist_id_2011 <- '37i9dQZF1DXcagnSNtrGuJ'
playlist_id_2012 <- '37i9dQZF1DX0yEZaMOXna3'
playlist_id_2013 <- '37i9dQZF1DX3Sp0P28SIer'
playlist_id_2014 <- '37i9dQZF1DX0h0QnLkMBl4'
playlist_id_2015 <- '37i9dQZF1DX9ukdrXQLJGZ'
playlist_id_2016 <- '37i9dQZF1DX8XZ6AUo9R4R'
playlist_id_2017 <- '37i9dQZF1DWTE7dVUebpUW'
playlist_id_2018 <- '37i9dQZF1DXe2bobNYDtW8'
playlist_id_2019 <- '37i9dQZF1DWVRSukIED0e9'
playlist_id_2020 <- '2fmTTbBkXi8pewbUvG3CeZ'
playlist_id_2021 <- '5GhQiRkGuqzpWZSE7OU4Se'
playlist_id_2022 <- '56r5qRUv3jSxADdmBkhcz7'
```

The following must be run each time you want to pull as access tokens expire.
```{r}
# Set up ID's and call access token
Sys.setenv(SPOTIFY_CLIENT_ID = 'b3b1a30581bc4e9ab567b8615b0c92df')
Sys.setenv(SPOTIFY_CLIENT_SECRET = 'd7e21641fa9e46f383d6681eb561d949')

access_token <- get_spotify_access_token()
```

100 songs per playlist unless denoted below. These will need to be pulled with an offset if larger than 100 songs.
    -2016
        -130
    -2020
        -135
Pulling of playlist data allows us to get the track IDs and then use those track IDs to pull track specific attributes in a future section.
```{r}
# Pull playlist data from Spotify API without track specific attributes
top_2011_playlist <- get_playlist_tracks(
                        playlist_id_2011,
                        authorization = access_token
                    )
top_2012_playlist <- get_playlist_tracks(
                        playlist_id_2012,
                        authorization = access_token
                    )
top_2013_playlist <- get_playlist_tracks(
                        playlist_id_2013,
                        authorization = access_token
                    )
top_2014_playlist <- get_playlist_tracks(
                        playlist_id_2014,
                        authorization = access_token
                    )
top_2015_playlist <- get_playlist_tracks(
                        playlist_id_2015,
                        authorization = access_token
                    )
top_2016_playlist_1 <- get_playlist_tracks(
                        playlist_id_2016,
                        authorization = access_token
                    )
top_2016_playlist_2 <- get_playlist_tracks(
                        playlist_id_2016,
                        offset = 100,
                        authorization = access_token
                    )
top_2017_playlist <- get_playlist_tracks(
                        playlist_id_2017,
                        authorization = access_token
                    )
top_2018_playlist <- get_playlist_tracks(
                        playlist_id_2018,
                        authorization = access_token
                    )
top_2019_playlist <- get_playlist_tracks(
                        playlist_id_2019,
                        authorization = access_token
                    )
top_2020_playlist_1 <- get_playlist_tracks(
                        playlist_id_2020,
                        authorization = access_token
                    )
top_2020_playlist_2 <- get_playlist_tracks(
                        playlist_id_2020,
                        offset = 100,
                        authorization = access_token
                    )
top_2021_playlist <- get_playlist_tracks(
                        playlist_id_2021,
                        authorization = access_token
                    )
top_2022_playlist <- get_playlist_tracks(
                        playlist_id_2022,
                        authorization = access_token
                    )
```

Need to merge dataframes of the playlists that needed multiple pulls using offsets above.
```{r}
# Merges the dataframes from playlists that were pulled multiple times
top_2016_playlist <- rbind(top_2016_playlist_1, top_2016_playlist_2)
top_2020_playlist <- rbind(top_2020_playlist_1, top_2020_playlist_2)
```

```{r}
#subsets the data to use the track ids later
top_2011_track_ids <- select(top_2011_playlist, track.id)
top_2012_track_ids <- select(top_2012_playlist, track.id)
top_2013_track_ids <- select(top_2013_playlist, track.id)
top_2014_track_ids <- select(top_2014_playlist, track.id)
top_2015_track_ids <- select(top_2015_playlist, track.id)
top_2016_track_ids <- select(top_2016_playlist, track.id)
top_2017_track_ids <- select(top_2017_playlist, track.id)
top_2018_track_ids <- select(top_2018_playlist, track.id)
top_2019_track_ids <- select(top_2019_playlist, track.id)
top_2020_track_ids <- select(top_2020_playlist, track.id)
top_2021_track_ids <- select(top_2021_playlist, track.id)
top_2022_track_ids <- select(top_2022_playlist, track.id)

# Pulls data for each playlist using the track IDs pulled above
top_2011_tracks <- list()
for (i in 1:nrow(top_2011_track_ids))
    top_2011_tracks[[i]] <- get_track_audio_features(
                                top_2011_track_ids[i, ],
                                authorization = access_token
                                )
top_2011_tracks_df <- rbindlist(top_2011_tracks, use.names=TRUE)

top_2012_tracks <- list()
for (i in 1:nrow(top_2012_track_ids))
    top_2012_tracks[[i]] <- get_track_audio_features(
                                top_2012_track_ids[i, ],
                                authorization = access_token
                                )
top_2012_tracks_df <- rbindlist(top_2012_tracks, use.names=TRUE)

top_2013_tracks <- list()
for (i in 1:nrow(top_2013_track_ids))
    top_2013_tracks[[i]] <- get_track_audio_features(
                                top_2013_track_ids[i, ],
                                authorization = access_token
                                )
top_2013_tracks_df <- rbindlist(top_2013_tracks, use.names=TRUE)

top_2014_tracks <- list()
for (i in 1:nrow(top_2014_track_ids))
    top_2014_tracks[[i]] <- get_track_audio_features(
                                top_2014_track_ids[i, ],
                                authorization = access_token
                                )
top_2014_tracks_df <- rbindlist(top_2014_tracks, use.names=TRUE)

top_2015_tracks <- list()
for (i in 1:nrow(top_2015_track_ids))
    top_2015_tracks[[i]] <- get_track_audio_features(
                                top_2015_track_ids[i, ],
                                authorization = access_token
                                )
top_2015_tracks_df <- rbindlist(top_2015_tracks, use.names=TRUE)

top_2016_tracks <- list()
for (i in 1:nrow(top_2016_track_ids))
    top_2016_tracks[[i]] <- get_track_audio_features(
                                top_2016_track_ids[i, ],
                                authorization = access_token
                                )
top_2016_tracks_df <- rbindlist(top_2016_tracks, use.names=TRUE)

top_2017_tracks <- list()
for (i in 1:nrow(top_2017_track_ids))
    top_2017_tracks[[i]] <- get_track_audio_features(
                                top_2017_track_ids[i, ],
                                authorization = access_token
                                )
top_2017_tracks_df <- rbindlist(top_2017_tracks, use.names=TRUE)

top_2018_tracks <- list()
for (i in 1:nrow(top_2018_track_ids))
    top_2018_tracks[[i]] <- get_track_audio_features(
                                top_2018_track_ids[i, ],
                                authorization = access_token
                                )
top_2018_tracks_df <- rbindlist(top_2018_tracks, use.names=TRUE)

top_2019_tracks <- list()
for (i in 1:nrow(top_2019_track_ids))
    top_2019_tracks[[i]] <- get_track_audio_features(
                                top_2019_track_ids[i, ],
                                authorization = access_token
                                )
top_2019_tracks_df <- rbindlist(top_2019_tracks, use.names=TRUE)

top_2020_tracks <- list()
for (i in 1:nrow(top_2020_track_ids))
    top_2020_tracks[[i]] <- get_track_audio_features(
                                top_2020_track_ids[i, ],
                                authorization = access_token
                                )
top_2020_tracks_df <- rbindlist(top_2020_tracks, use.names=TRUE)

top_2021_tracks <- list()
for (i in 1:nrow(top_2021_track_ids))
    top_2021_tracks[[i]] <- get_track_audio_features(
                                top_2021_track_ids[i, ],
                                authorization = access_token
                                )
top_2021_tracks_df <- rbindlist(top_2021_tracks, use.names=TRUE)

top_2022_tracks <- list()
for (i in 1:nrow(top_2022_track_ids))
    top_2022_tracks[[i]] <- get_track_audio_features(
                                top_2022_track_ids[i, ],
                                authorization = access_token
                                )
top_2022_tracks_df <- rbindlist(top_2022_tracks, use.names=TRUE)
```

Save the data to files individually for use in separate files. Saved as RDS files to preserve lists of artists, and other lists in data. Will adjust the lists to df when using data.
```{r}
# Save original data to rds files for future use and manipulation
saveRDS(top_2011_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2011_playlist.rds"          )
saveRDS(top_2012_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2012_playlist.rds"
          )
saveRDS(top_2013_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2013_playlist.rds"
          )
saveRDS(top_2014_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2014_playlist.rds"
          )
saveRDS(top_2015_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2015_playlist.rds"
          )
saveRDS(top_2016_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2016_playlist.rds"
          )
saveRDS(top_2017_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2017_playlist.rds"
          )
saveRDS(top_2018_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2018_playlist.rds"
          )
saveRDS(top_2019_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2019_playlist.rds"
          )
saveRDS(top_2020_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2020_playlist.rds"
          )
saveRDS(top_2021_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2021_playlist.rds"
          )
saveRDS(top_2022_playlist,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2022_playlist.rds"
          )
write_csv(top_2011_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2011_track_attributes.csv"
        )
write_csv(top_2012_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2012_track_attributes.csv"
        )
write_csv(top_2013_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2013_track_attributes.csv"
        )
write_csv(top_2014_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2014_track_attributes.csv"
        )
write_csv(top_2015_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2015_track_attributes.csv"
        )
write_csv(top_2016_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2016_track_attributes.csv"
        )
write_csv(top_2017_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2017_track_attributes.csv"
        )
write_csv(top_2018_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2018_track_attributes.csv"
        )
write_csv(top_2019_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2019_track_attributes.csv"
        )
write_csv(top_2020_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2020_track_attributes.csv"
        )
write_csv(top_2021_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2021_track_attributes.csv"
        )
write_csv(top_2022_tracks_df,
        "C:\\Users\\amend\\Documents\\School\\SPE_486_predictive_analytics_and_machine_learning\\SPE_486_final_project\\top_2022_track_attributes.csv"
        )
```